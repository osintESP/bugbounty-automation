#!/usr/bin/env python3
"""
Exploit Orchestrator - Coordinates the full exploit pipeline
Reconnaissance â†’ Vulnerability Detection â†’ Exploitation
"""
from typing import Dict, List, Optional
from modules.recon.fingerprint import Fingerprinter
from modules.recon.path_discovery import PathDiscovery
from modules.scan.cve_matcher import CVEMatcher
from modules.exploit.exploit_db import ExploitDB
from modules.exploit.exploit_engine import ExploitEngine
from utils.logger import logger


class ExploitOrchestrator:
    """Orchestrates the complete exploit pipeline"""
    
    def __init__(self, target: str, config: Dict = None):
        self.target = target
        self.config = config or {}
        self.results = {
            'target': target,
            'fingerprint': None,
            'paths': None,
            'cves': None,
            'exploits': None
        }
        
    def run_full_pipeline(self, auto_exploit: bool = False, dry_run: bool = False) -> Dict:
        """
        Execute complete pipeline: Recon â†’ Detection â†’ Exploitation
        
        Args:
            auto_exploit: If True, automatically exploit all found vulnerabilities
            dry_run: If True, don't actually execute exploits
        
        Returns:
            Complete results dictionary
        """
        logger.info(f"Starting full exploit pipeline for {self.target}")
        logger.info(f"Auto-exploit: {auto_exploit}, Dry-run: {dry_run}")
        
        # Phase 1: Reconnaissance
        logger.info("=" * 60)
        logger.info("PHASE 1: RECONNAISSANCE")
        logger.info("=" * 60)
        
        fingerprint_result = self.fingerprint()
        path_result = self.discover_paths(fingerprint_result)
        
        # Phase 2: Vulnerability Detection
        logger.info("\n" + "=" * 60)
        logger.info("PHASE 2: VULNERABILITY DETECTION")
        logger.info("=" * 60)
        
        cve_result = self.match_cves(fingerprint_result)
        
        # Phase 3: Exploitation (if auto_exploit or dry_run)
        if auto_exploit or dry_run:
            logger.info("\n" + "=" * 60)
            logger.info("PHASE 3: EXPLOITATION")
            logger.info("=" * 60)
            
            exploit_result = self.exploit(cve_result, path_result, dry_run=dry_run)
        else:
            logger.info("\n" + "=" * 60)
            logger.info("PHASE 3: EXPLOITATION - SKIPPED (use --auto or --dry-run)")
            logger.info("=" * 60)
            exploit_result = None
        
        # Compile final results
        self.results = {
            'target': self.target,
            'fingerprint': fingerprint_result,
            'paths': path_result,
            'cves': cve_result,
            'exploits': exploit_result,
            'summary': self._generate_summary()
        }
        
        return self.results
    
    def fingerprint(self) -> Dict:
        """Phase 1a: Fingerprint target"""
        logger.info("[1/3] Fingerprinting target...")
        
        fingerprinter = Fingerprinter(self.target)
        result = fingerprinter.run()
        
        self.results['fingerprint'] = result
        
        # Log findings
        logger.info(f"âœ“ Server: {result.get('server', 'Unknown')}")
        logger.info(f"âœ“ Language: {result.get('language', 'Unknown')}")
        logger.info(f"âœ“ Framework: {result.get('framework', 'Unknown')}")
        logger.info(f"âœ“ CMS: {result.get('cms', 'None')}")
        logger.info(f"âœ“ Confidence: {result.get('confidence', 0):.2%}")
        
        return result
    
    def discover_paths(self, fingerprint: Dict = None) -> Dict:
        """Phase 1b: Discover paths and endpoints"""
        logger.info("\n[2/3] Discovering paths and endpoints...")
        
        # Extract technologies for targeted path discovery
        technologies = []
        if fingerprint:
            if fingerprint.get('server') and 'Apache' in fingerprint.get('server', ''):
                technologies.append('Apache')
            if fingerprint.get('language'):
                technologies.append(fingerprint['language'])
            if fingerprint.get('framework'):
                technologies.append(fingerprint['framework'])
            if fingerprint.get('cms'):
                technologies.append(fingerprint['cms'])
        
        # Configure path discovery
        threads = self.config.get('path_discovery', {}).get('threads', 10)
        wordlist = self.config.get('path_discovery', {}).get('wordlist')
        
        discovery = PathDiscovery(self.target, wordlist=wordlist, threads=threads)
        paths = discovery.run(technologies=technologies)
        
        result = discovery.export_results()
        self.results['paths'] = result
        
        # Log findings
        logger.info(f"âœ“ Total paths found: {len(paths)}")
        logger.info(f"âœ“ Accessible paths: {result.get('accessible', 0)}")
        logger.info(f"âœ“ Sensitive files: {result.get('sensitive', 0)}")
        
        # Show top findings
        if paths:
            logger.info("\nTop findings:")
            for path in paths[:5]:
                logger.info(f"  â€¢ {path['path']} [{path['status']}] - {path.get('reason', '')}")
        
        return result
    
    def match_cves(self, fingerprint: Dict = None) -> Dict:
        """Phase 2: Match CVEs based on fingerprint"""
        logger.info("\n[3/3] Matching CVEs...")
        
        if not fingerprint:
            fingerprint = self.results.get('fingerprint')
        
        if not fingerprint:
            logger.warning("No fingerprint available, skipping CVE matching")
            return {'cves': []}
        
        # Configure CVE matcher
        severity_filter = self.config.get('cve_matcher', {}).get('severity_filter', ['critical', 'high'])
        
        matcher = CVEMatcher()
        cves = matcher.match(fingerprint, severity_filter=severity_filter)
        
        result = matcher.export_results(cves)
        self.results['cves'] = result
        
        # Log findings
        logger.info(f"âœ“ Total CVEs found: {len(cves)}")
        logger.info(f"âœ“ Exploitable CVEs: {result.get('exploitable', 0)}")
        logger.info(f"âœ“ Critical: {result['by_severity'].get('critical', 0)}")
        logger.info(f"âœ“ High: {result['by_severity'].get('high', 0)}")
        
        # Show CVEs
        if cves:
            logger.info("\nMatched CVEs:")
            for cve in cves:
                severity_emoji = {'critical': 'ðŸ”´', 'high': 'ðŸŸ ', 'medium': 'ðŸŸ¡'}.get(cve.get('severity'), 'âšª')
                logger.info(f"  {severity_emoji} {cve['cve']} - {cve['description']}")
                logger.info(f"     CVSS: {cve.get('cvss', 'N/A')} | Exploit: {'âœ“' if cve.get('exploit_available') else 'âœ—'}")
        
        return result
    
    def exploit(self, cve_result: Dict = None, path_result: Dict = None, dry_run: bool = False) -> Dict:
        """Phase 3: Execute exploits"""
        logger.info("\nExecuting exploits...")
        
        if not cve_result:
            cve_result = self.results.get('cves', {})
        
        if not path_result:
            path_result = self.results.get('paths', {})
        
        cves = cve_result.get('cves', [])
        paths = path_result.get('paths', [])
        
        if not cves:
            logger.warning("No CVEs to exploit")
            return {'results': []}
        
        # Get exploitable CVEs
        exploitable_cves = [cve for cve in cves if cve.get('exploit_available', False)]
        
        if not exploitable_cves:
            logger.warning("No exploitable CVEs found")
            return {'results': []}
        
        logger.info(f"Found {len(exploitable_cves)} exploitable CVEs")
        
        # Load exploit database
        exploit_db = ExploitDB()
        
        # Get exploit templates
        exploits_to_run = []
        for cve in exploitable_cves:
            cve_id = cve.get('cve')
            exploit = exploit_db.get_exploit(cve_id)
            if exploit:
                exploits_to_run.append(exploit)
                logger.info(f"âœ“ Loaded exploit for {cve_id}")
            else:
                logger.warning(f"âœ— No exploit template for {cve_id}")
        
        # Also try generic exploits
        generic_exploits = exploit_db.get_generic_exploits()
        logger.info(f"Adding {len(generic_exploits)} generic exploits")
        exploits_to_run.extend(generic_exploits)
        
        # Execute exploits
        engine = ExploitEngine(self.target, dry_run=dry_run)
        results = engine.execute_multiple(exploits_to_run, discovered_paths=paths)
        
        result = engine.export_results()
        self.results['exploits'] = result
        
        # Log results
        logger.info(f"\nâœ“ Exploits executed: {result.get('total_exploits', 0)}")
        logger.info(f"âœ“ Successful: {result.get('successful', 0)}")
        logger.info(f"âœ“ Failed: {result.get('failed', 0)}")
        
        # Show successful exploits
        successful = engine.get_successful_exploits()
        if successful:
            logger.info("\nðŸŽ¯ SUCCESSFUL EXPLOITS:")
            for exploit in successful:
                severity_emoji = {'critical': 'ðŸ”´', 'high': 'ðŸŸ ', 'medium': 'ðŸŸ¡'}.get(exploit.get('severity'), 'âšª')
                logger.info(f"  {severity_emoji} {exploit['exploit_name']}")
                if exploit.get('cve'):
                    logger.info(f"     CVE: {exploit['cve']}")
                logger.info(f"     Type: {exploit.get('type', 'Unknown')}")
                
                # Show successful payloads
                for payload in exploit.get('successful_payloads', []):
                    logger.info(f"     âœ“ {payload['name']}: {payload.get('successful_url', '')}")
        
        return result
    
    def _generate_summary(self) -> Dict:
        """Generate executive summary of results"""
        summary = {
            'target': self.target,
            'technologies_detected': 0,
            'paths_discovered': 0,
            'cves_found': 0,
            'exploitable_cves': 0,
            'successful_exploits': 0,
            'risk_level': 'low'
        }
        
        # Count technologies
        if self.results.get('fingerprint'):
            fp = self.results['fingerprint']
            if fp.get('server'):
                summary['technologies_detected'] += 1
            if fp.get('language'):
                summary['technologies_detected'] += 1
            if fp.get('framework'):
                summary['technologies_detected'] += 1
            if fp.get('cms'):
                summary['technologies_detected'] += 1
        
        # Count paths
        if self.results.get('paths'):
            summary['paths_discovered'] = self.results['paths'].get('total_found', 0)
        
        # Count CVEs
        if self.results.get('cves'):
            summary['cves_found'] = self.results['cves'].get('total_cves', 0)
            summary['exploitable_cves'] = self.results['cves'].get('exploitable', 0)
        
        # Count successful exploits
        if self.results.get('exploits'):
            summary['successful_exploits'] = self.results['exploits'].get('successful', 0)
        
        # Determine risk level
        if summary['successful_exploits'] > 0:
            summary['risk_level'] = 'critical'
        elif summary['exploitable_cves'] > 0:
            summary['risk_level'] = 'high'
        elif summary['cves_found'] > 0:
            summary['risk_level'] = 'medium'
        
        return summary
