#!/usr/bin/env python3
"""
Demo script for the exploit framework
Tests the complete pipeline against vulnerable-app
"""
import sys
from pathlib import Path

# Add src to path
sys.path.insert(0, str(Path(__file__).parent / 'src'))

from modules.exploit.orchestrator import ExploitOrchestrator
from utils.logger import setup_logger
from rich.console import Console
from rich.table import Table
import json

console = Console()

def main():
    # Setup logger
    logger = setup_logger(level='INFO')
    
    # Target
    target = "http://vulnerable-app:5000"
    
    console.print("[bold magenta]" + "=" * 70 + "[/bold magenta]")
    console.print("[bold magenta]ðŸŽ¯ BUG BOUNTY TOOL - AUTOMATED EXPLOIT FRAMEWORK DEMO[/bold magenta]")
    console.print("[bold magenta]" + "=" * 70 + "[/bold magenta]")
    console.print(f"\n[cyan]Target:[/cyan] {target}\n")
    
    # Create orchestrator
    orchestrator = ExploitOrchestrator(target)
    
    # Run full pipeline in dry-run mode first
    console.print("[yellow]Running in DRY-RUN mode first...[/yellow]\n")
    results_dry = orchestrator.run_full_pipeline(auto_exploit=False, dry_run=True)
    
    # Show summary
    console.print("\n" + "=" * 70)
    console.print("[bold]ðŸ“Š RESULTS SUMMARY[/bold]")
    console.print("=" * 70 + "\n")
    
    summary = results_dry.get('summary', {})
    
    # Create summary table
    table = Table(title="Executive Summary", show_header=True)
    table.add_column("Metric", style="cyan", width=30)
    table.add_column("Value", style="green", width=20)
    
    table.add_row("ðŸŽ¯ Target", summary.get('target', 'N/A'))
    table.add_row("ðŸ” Technologies Detected", str(summary.get('technologies_detected', 0)))
    table.add_row("ðŸ“ Paths Discovered", str(summary.get('paths_discovered', 0)))
    table.add_row("ðŸ”“ CVEs Found", str(summary.get('cves_found', 0)))
    table.add_row("ðŸ’¥ Exploitable CVEs", str(summary.get('exploitable_cves', 0)))
    
    risk_colors = {
        'critical': 'red',
        'high': 'orange1',
        'medium': 'yellow',
        'low': 'green'
    }
    risk_level = summary.get('risk_level', 'low')
    table.add_row("âš ï¸  Risk Level", f"[{risk_colors.get(risk_level, 'white')}]{risk_level.upper()}[/{risk_colors.get(risk_level, 'white')}]")
    
    console.print(table)
    
    # Show discovered technologies
    if results_dry.get('fingerprint'):
        fp = results_dry['fingerprint']
        console.print("\n[bold]ðŸ” Detected Technologies:[/bold]")
        if fp.get('server'):
            console.print(f"  â€¢ Server: {fp['server']}")
        if fp.get('language'):
            console.print(f"  â€¢ Language: {fp['language']}")
        if fp.get('framework'):
            console.print(f"  â€¢ Framework: {fp['framework']}")
        console.print(f"  â€¢ Confidence: {fp.get('confidence', 0):.1%}")
    
    # Show discovered paths
    if results_dry.get('paths'):
        paths = results_dry['paths'].get('paths', [])
        if paths:
            console.print("\n[bold]ðŸ“ Top Discovered Paths:[/bold]")
            for path in paths[:5]:
                status_color = 'green' if path['status'] == 200 else 'yellow'
                console.print(f"  â€¢ [{status_color}]{path['path']}[/{status_color}] [{path['status']}] - {path.get('reason', '')}")
    
    # Show CVEs
    if results_dry.get('cves'):
        cves = results_dry['cves'].get('cves', [])
        if cves:
            console.print("\n[bold]ðŸ”“ Matched CVEs:[/bold]")
            for cve in cves:
                severity_emoji = {'critical': 'ðŸ”´', 'high': 'ðŸŸ ', 'medium': 'ðŸŸ¡'}.get(cve.get('severity'), 'âšª')
                console.print(f"  {severity_emoji} {cve['cve']} - {cve['description']}")
                console.print(f"     CVSS: {cve.get('cvss', 'N/A')} | Exploit Available: {'âœ“' if cve.get('exploit_available') else 'âœ—'}")
    
    # Ask to run actual exploits
    console.print("\n" + "=" * 70)
    
    if summary.get('exploitable_cves', 0) > 0:
        console.print("\n[bold yellow]ðŸ’¡ Found exploitable vulnerabilities![/bold yellow]")
        console.print("[yellow]Run with auto_exploit=True to execute actual exploits[/yellow]")
        
        # For demo purposes, run actual exploits
        console.print("\n[bold red]Running ACTUAL exploits now...[/bold red]\n")
        
        # Create new orchestrator for actual exploitation
        orchestrator2 = ExploitOrchestrator(target)
        results_real = orchestrator2.run_full_pipeline(auto_exploit=True, dry_run=False)
        
        # Show successful exploits
        if results_real.get('exploits'):
            exploits = results_real['exploits']
            successful = exploits.get('successful', 0)
            
            console.print(f"\n[bold green]âœ… Successfully exploited {successful} vulnerabilities![/bold green]")
            
            # Show details
            for result in exploits.get('results', []):
                if result.get('success'):
                    console.print(f"\n[bold]ðŸŽ¯ {result['exploit_name']}[/bold]")
                    if result.get('cve'):
                        console.print(f"   CVE: {result['cve']}")
                    console.print(f"   Type: {result.get('type', 'Unknown')}")
                    console.print(f"   Severity: {result.get('severity', 'Unknown')}")
                    
                    for payload in result.get('successful_payloads', []):
                        console.print(f"   âœ“ {payload['name']}")
                        console.print(f"     URL: {payload.get('successful_url', 'N/A')}")
                        if payload.get('proof', {}).get('snippet'):
                            snippet = payload['proof']['snippet'][:100]
                            console.print(f"     Proof: {snippet}...")
    
    # Save results
    console.print("\n" + "=" * 70)
    output_file = Path('./reports/demo_exploit_results.json')
    output_file.parent.mkdir(exist_ok=True)
    
    with open(output_file, 'w') as f:
        json.dump(results_real if 'results_real' in locals() else results_dry, f, indent=2)
    
    console.print(f"[green]âœ“ Results saved to: {output_file}[/green]")
    console.print("\n[bold green]ðŸŽ‰ Demo completed successfully![/bold green]\n")


if __name__ == "__main__":
    main()
